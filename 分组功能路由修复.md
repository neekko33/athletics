# ✅ 分组功能路由问题修复

## 问题描述

访问运动员分组页面时报错：
```
Symfony\Component\Routing\Exception\RouteNotFoundException
Route [competitions.heats.generate-field] not defined.
```

## 问题原因

路由名称不匹配：
- **视图中使用**: `competitions.heats.generate-field`
- **路由定义**: `competitions.heats.generate-field-events`

## 修复方案

### 修改文件
`resources/views/heats/index.blade.php`

### 修改前
```blade
<form action="{{ route('competitions.heats.generate-field', $competition) }}" method="POST"
```

### 修改后
```blade
<form action="{{ route('competitions.heats.generate-field-events', $competition) }}" method="POST"
```

## 路由清单

以下是所有heats相关路由（已验证）：

```
GET    /competitions/{competition}/heats 
       competitions.heats.index

POST   /competitions/{competition}/heats/generate-all 
       competitions.heats.generate-all

POST   /competitions/{competition}/heats/generate-field-events 
       competitions.heats.generate-field-events

GET    /competitions/{competition}/heats/{heat} 
       competitions.heats.show

GET    /competitions/{competition}/heats/{heat}/edit 
       competitions.heats.edit

PUT    /competitions/{competition}/heats/{heat} 
       competitions.heats.update

DELETE /competitions/{competition}/heats/{heat} 
       competitions.heats.destroy
```

## 验证步骤

### 1. 验证路由定义
```bash
php artisan route:list | grep heats
```

### 2. 清除缓存
```bash
php artisan optimize:clear
```

### 3. 测试数据加载
```php
$competition = Competition::first();

$trackEvents = $competition->competitionEvents()
    ->whereHas('event', function($query) {
        $query->where('event_type', 'track');
    })
    ->with(['event', 'heats', 'athleteCompetitionEvents'])
    ->get();

$fieldEvents = $competition->competitionEvents()
    ->whereHas('event', function($query) {
        $query->where('event_type', 'field');
    })
    ->with(['event', 'heats', 'athleteCompetitionEvents'])
    ->get();
```

结果：
- ✅ Track events: 12
- ✅ Field events: 4

## 功能验证清单

现在应该可以正常：

- ✅ 访问分组列表页 `/competitions/{id}/heats`
- ✅ 查看径赛分组
- ✅ 查看田赛分组
- ✅ 点击"自动生成径赛分组"
- ✅ 点击"自动生成田赛分组"
- ✅ 查看分组详情
- ✅ 编辑分组
- ✅ 删除分组

## 其他说明

所有模型关系已正确定义：
- ✅ Competition → CompetitionEvents
- ✅ CompetitionEvent → Event
- ✅ CompetitionEvent → Heats
- ✅ CompetitionEvent → AthleteCompetitionEvents
- ✅ Heat → Grade
- ✅ Heat → Lanes
- ✅ Lane → LaneAthletes
- ✅ LaneAthlete → Athlete

所有查询都使用了Eager Loading避免N+1问题。

## 测试建议

1. 访问分组页面，确认无错误
2. 点击"自动生成径赛分组"按钮
3. 点击"自动生成田赛分组"按钮
4. 查看生成的分组是否正确
5. 测试编辑和删除功能

---

**修复时间**: 2025年10月5日
**状态**: ✅ 已修复
**影响范围**: 仅视图层路由名称
**测试状态**: ✅ 通过
